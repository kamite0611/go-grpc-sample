# gRPC 概要

## gRPCとは

gRPC（gRPC Remote Procedure Call）は、Googleが開発したオープンソースのRPCフレームワークです。

**RPC = Remote Procedure Call（遠隔手続き呼び出し）**

ネットワーク越しのサーバー処理を、ローカルの関数を呼び出すように実行できます。

```
クライアント                           サーバー
     │                                   │
     │  client.SayHello(request)         │
     │  ────────────────────────────▶    │
     │                                   │  処理実行
     │           response                │
     │  ◀────────────────────────────    │
     │                                   │
```

## REST API / GraphQL との比較

| 項目 | REST API | GraphQL | gRPC |
|-----|----------|---------|------|
| プロトコル | HTTP/1.1 | HTTP/1.1 | HTTP/2 |
| データ形式 | JSON | JSON | Protocol Buffers（バイナリ） |
| 速度 | 遅め | 遅め | 高速 |
| 型安全性 | 弱い | 中（スキーマあり） | 強い（コンパイル時チェック） |
| ストリーミング | 難しい | Subscriptionで対応 | 標準サポート |
| ブラウザ対応 | そのまま使える | そのまま使える | grpc-web が必要 |
| コード生成 | 手動 or OpenAPI | 手動 or codegen | protoから自動生成 |
| クエリの柔軟性 | 低い（エンドポイント固定） | 高い（必要なフィールドを指定） | 低い（メソッド固定） |
| 主な用途 | 外部公開API | フロントエンド向けAPI | マイクロサービス間通信 |

### 使い分けの目安

```
┌─────────────────────────────────────────────────────────────┐
│                        クライアント                          │
├─────────────────┬─────────────────┬─────────────────────────┤
│   Webブラウザ    │  モバイルアプリ  │  マイクロサービス        │
│                 │  (BFF経由)      │  IoTデバイス            │
├─────────────────┼─────────────────┼─────────────────────────┤
│    GraphQL      │   GraphQL       │        gRPC             │
│    REST         │   REST          │                         │
└─────────────────┴─────────────────┴─────────────────────────┘
```

| 選択肢 | こんなときに使う |
|-------|----------------|
| **REST** | シンプルなCRUD、外部公開API、広く使われる標準が欲しい |
| **GraphQL** | フロントエンドが柔軟にデータ取得したい、オーバーフェッチを避けたい |
| **gRPC** | 高速通信が必要、型安全を重視、マイクロサービス間、IoT/モバイル |

### 組み合わせパターン

実際のプロダクトでは組み合わせて使うことが多いです。

```
┌─────────────┐
│  ブラウザ    │──── GraphQL ────┐
└─────────────┘                 │
                                ▼
┌─────────────┐           ┌───────────┐
│  iOS App    │── gRPC ──▶│  Backend  │
└─────────────┘           │  (Go)     │
                          └─────┬─────┘
┌─────────────┐                 │ gRPC
│  IoTデバイス │── gRPC ─────────┼──────────┐
└─────────────┘                 │          │
                                ▼          ▼
                          ┌──────────┐ ┌──────────┐
                          │ Service  │ │ Service  │
                          │    A     │ │    B     │
                          └──────────┘ └──────────┘
```

## gRPCの主な特徴

### 1. Protocol Buffers（protobuf）

サービスのインターフェースをスキーマで定義します。

```protobuf
service Greeter {
  rpc SayHello (HelloRequest) returns (HelloResponse);
}

message HelloRequest {
  string name = 1;
}

message HelloResponse {
  string message = 1;
}
```

このprotoファイルから各言語のコードを自動生成できます。

### 2. 多言語対応

同じprotoファイルから複数の言語のコードを生成できます。

```
proto/greeter.proto
        │
        ├─── Go        (サーバー)
        ├─── Swift     (iOSアプリ)
        ├─── Kotlin    (Androidアプリ)
        ├─── Python    (バッチ処理)
        ├─── TypeScript(Webフロントエンド)
        └─── C++       (IoTデバイス)
```

### 3. 4種類の通信パターン

| パターン | 説明 | ユースケース |
|---------|------|-------------|
| **Unary RPC** | 1リクエスト → 1レスポンス | 通常のAPI呼び出し |
| **Server Streaming** | 1リクエスト → 複数レスポンス | リアルタイム通知、ログ配信 |
| **Client Streaming** | 複数リクエスト → 1レスポンス | ファイルアップロード |
| **Bidirectional Streaming** | 複数リクエスト ↔ 複数レスポンス | チャット、リアルタイム同期 |

```protobuf
service Example {
  // Unary
  rpc GetUser (UserRequest) returns (UserResponse);

  // Server Streaming
  rpc WatchEvents (WatchRequest) returns (stream Event);

  // Client Streaming
  rpc UploadFile (stream FileChunk) returns (UploadResult);

  // Bidirectional Streaming
  rpc Chat (stream Message) returns (stream Message);
}
```

### 4. HTTP/2ベース

- **多重化**: 1つの接続で複数のリクエストを同時処理
- **ヘッダー圧縮**: 通信オーバーヘッドを削減
- **サーバープッシュ**: サーバーからクライアントへ能動的に送信

## gRPCが適しているケース

### マイクロサービス間通信

```
┌─────────┐     ┌─────────┐     ┌─────────┐
│ Service │────▶│ Service │────▶│ Service │
│    A    │gRPC │    B    │gRPC │    C    │
└─────────┘     └─────────┘     └─────────┘
```

- 型安全な通信でバグを防止
- 高速なバイナリ通信
- 共通のprotoでインターフェースを管理

### モバイルアプリ ↔ サーバー

```
┌─────────────┐           ┌─────────────┐
│  iOS App    │           │   Server    │
│  (Swift)    │◀── gRPC ─▶│   (Go)      │
└─────────────┘           └─────────────┘
┌─────────────┐                 │
│ Android App │◀── gRPC ────────┘
│  (Kotlin)   │
└─────────────┘
```

- バイナリ形式で通信量削減（バッテリー・帯域に優しい）
- ストリーミングでリアルタイム更新

### IoTデバイス連携

```
┌─────────────┐           ┌─────────────┐           ┌─────────────┐
│  IoTデバイス │           │   Server    │           │    App      │
│   (C++)     │◀── gRPC ─▶│   (Go)      │◀── gRPC ─▶│  (Swift)    │
└─────────────┘           └─────────────┘           └─────────────┘
     │                                                    │
     └────────────── 同じprotoを共有 ─────────────────────┘
```

- 軽量なバイナリ通信（リソース制約のあるデバイス向け）
- Bidirectional Streamingでリアルタイム状態同期
- 厳密な型定義でデバイス間の整合性を保証

## gRPCが適さないケース

| ケース | 理由 | 代替案 |
|-------|------|--------|
| ブラウザ向けAPI | 直接gRPCを使えない | REST, GraphQL, grpc-web |
| 外部公開API | デバッグしにくい、ツールが少ない | REST (OpenAPI) |
| シンプルなCRUD | オーバースペック | REST |

## 一般的な構成パターン

```
                    ┌─────────────────────────┐
                    │      Load Balancer      │
                    └───────────┬─────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
        ▼                       ▼                       ▼
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│  API Gateway  │     │  API Gateway  │     │  API Gateway  │
│   (REST)      │     │   (REST)      │     │   (REST)      │
└───────┬───────┘     └───────┬───────┘     └───────┬───────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │ gRPC
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│   Service A   │◀───▶│   Service B   │◀───▶│   Service C   │
│               │gRPC │               │gRPC │               │
└───────────────┘     └───────────────┘     └───────────────┘
```

**外部 → REST / 内部 → gRPC** という構成が一般的です。

## 参考リンク

- [gRPC公式サイト](https://grpc.io/)
- [Protocol Buffers公式ドキュメント](https://protobuf.dev/)
- [grpc-go (Go実装)](https://github.com/grpc/grpc-go)
- [grpc-swift (Swift実装)](https://github.com/grpc/grpc-swift)
